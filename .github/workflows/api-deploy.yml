name: API Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'src/api/**'
  workflow_dispatch:  # 手動觸發

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd src/api
        pip install -r requirements.txt
    
    - name: Run quick tests
      run: |
        cd src/api
        pip install pytest pytest-asyncio
        pytest tests/test_cache.py -v --tb=short
    
    - name: Build and deploy notification
      run: |
        echo "✅ API ready for deployment"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
    
    # 以下是部署步驟範例（根據實際平台調整）
    
    # Vercel 部署範例
    # - name: Deploy to Vercel
    #   uses: amondnet/vercel-action@v20
    #   with:
    #     vercel-token: ${{ secrets.VERCEL_TOKEN }}
    #     vercel-org-id: ${{ secrets.ORG_ID }}
    #     vercel-project-id: ${{ secrets.PROJECT_ID }}
    #     working-directory: src/api
    
    # Railway 部署範例
    # - name: Deploy to Railway
    #   uses: bervProject/railway-deploy@main
    #   with:
    #     railway_token: ${{ secrets.RAILWAY_TOKEN }}
    #     service: api
    
    # Docker 建置範例
    # - name: Build Docker image
    #   run: |
    #     cd src/api
    #     docker build -t prompt-scribe-api:${{ github.sha }} .
    
    - name: Deployment summary
      run: |
        echo "### 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Ready" >> $GITHUB_STEP_SUMMARY

