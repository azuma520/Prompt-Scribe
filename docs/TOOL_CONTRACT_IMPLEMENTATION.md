# å·¥å…· I/O å¥‘ç´„å¯¦æ–½å®Œæˆå ±å‘Š

**æ—¥æœŸ**: 2025-01-27  
**ç‹€æ…‹**: âœ… å·²å®Œæˆ  
**ä¾æ“š**: `docs/INSPIRE_P0_CHECKLIST.md` Section 4

---

## ğŸ“‹ å¯¦æ–½æ‘˜è¦

å·²æˆåŠŸå¯¦æ–½ Inspire Agent å·¥å…·çš„ I/O å¥‘ç´„é©—è­‰ç³»çµ±ï¼Œç¢ºä¿æ‰€æœ‰å·¥å…·è¼¸å‡ºç¬¦åˆåš´æ ¼å¥‘ç´„è¦æ±‚ã€‚

---

## âœ… å®Œæˆé …ç›®

### 1. å¥‘ç´„é©—è­‰å™¨æ¨¡çµ„ (`src/api/utils/tool_contract_validator.py`)

å‰µå»ºäº†å®Œæ•´çš„å¥‘ç´„é©—è­‰ç³»çµ±ï¼ŒåŒ…å«ï¼š

- **UnderstandIntentOutput**: é©—è­‰ `understand_intent` è¼¸å‡º
  - åš´æ ¼ 6 å€‹éµé©—è­‰
  - `clarity_level` æšèˆ‰é©—è­‰
  - `confidence` ç¯„åœé©—è­‰ (0-1)
  - `next_action` æšèˆ‰é©—è­‰

- **GenerateIdeasOutput**: é©—è­‰ `generate_ideas` è¼¸å‡º
  - æ–¹å‘æ•¸é‡é©—è­‰ (2-3 å€‹)
  - æ¯å€‹æ–¹å‘ 6 å€‹éµé©—è­‰
  - `main_tags` è‡³å°‘ 10 å€‹æ¨™ç±¤
  - æ¨™é¡Œé•·åº¦é©—è­‰ (â‰¤10 å­—)

- **ValidateQualityOutput**: é©—è­‰ `validate_quality` è¼¸å‡º
  - åš´æ ¼ 8 å€‹é ‚å±¤éµé©—è­‰
  - `score` ç¯„åœé©—è­‰ (0-100)
  - `quick_fixes` çµæ§‹é©—è­‰ (remove/add/replace)

- **FinalizePromptOutput**: é©—è­‰ `finalize_prompt` è¼¸å‡º
  - `positive_prompt` é•·åº¦é©—è­‰ (<500 å­—)
  - `negative_prompt` å®‰å…¨å‰ç¶´æª¢æŸ¥
  - å¿…è¦æ¬„ä½é©—è­‰

### 2. å·¥å…·æ•´åˆ

æ‰€æœ‰å·¥å…·å‡½æ•¸å·²æ•´åˆé©—è­‰é‚è¼¯ï¼š

- âœ… `understand_intent` - è¼¸å‡ºé©—è­‰å·²æ•´åˆ
- âœ… `generate_ideas` - è¼¸å‡ºé©—è­‰å·²æ•´åˆ
- âœ… `validate_quality` - è¼¸å‡ºé©—è­‰å·²æ•´åˆ
- âœ… `finalize_prompt` - è¼¸å‡ºé©—è­‰å·²æ•´åˆ

**é©—è­‰ç­–ç•¥**:
- é©—è­‰å¤±æ•—æ™‚è¨˜éŒ„éŒ¯èª¤ï¼Œä½†ä¸é˜»æ­¢åŸ·è¡Œ
- é©—è­‰æˆåŠŸæ™‚è¿”å›æ¨™æº–åŒ–è¼¸å‡º
- ä½¿ç”¨ `CONTRACT_VALIDATION_ENABLED` é–‹é—œæ§åˆ¶

### 3. å–®å…ƒæ¸¬è©¦ (`tests/test_inspire_contracts.py`)

å‰µå»ºäº†å®Œæ•´çš„æ¸¬è©¦å¥—ä»¶ï¼š

- âœ… `TestUnderstandIntent` - 5 å€‹æ¸¬è©¦æ¡ˆä¾‹
  - æœ‰æ•ˆè¼¸å‡ºçµæ§‹æ¸¬è©¦
  - ç„¡æ•ˆä¿¡å¿ƒåº¦ç¯„åœæ¸¬è©¦
  - ç„¡æ•ˆæ¸…æ™°åº¦æšèˆ‰æ¸¬è©¦
  - ç„¡æ•ˆä¸‹ä¸€æ­¥è¡Œå‹•æ¸¬è©¦
  - ç¼ºå¤±å¿…è¦æ¬„ä½æ¸¬è©¦

- âœ… `TestGenerateIdeas` - 4 å€‹æ¸¬è©¦æ¡ˆä¾‹
  - æœ‰æ•ˆè¼¸å‡ºçµæ§‹æ¸¬è©¦
  - æ–¹å‘æ•¸é‡å¤ªå°‘æ¸¬è©¦
  - æ¨™ç±¤æ•¸é‡ä¸è¶³æ¸¬è©¦
  - æ¨™é¡Œéé•·æ¸¬è©¦

- âœ… `TestValidateQuality` - 3 å€‹æ¸¬è©¦æ¡ˆä¾‹
  - æœ‰æ•ˆè¼¸å‡ºçµæ§‹æ¸¬è©¦
  - ç„¡æ•ˆåˆ†æ•¸ç¯„åœæ¸¬è©¦
  - `quick_fixes` çµæ§‹æ¸¬è©¦

- âœ… `TestFinalizePrompt` - 3 å€‹æ¸¬è©¦æ¡ˆä¾‹
  - æœ‰æ•ˆè¼¸å‡ºçµæ§‹æ¸¬è©¦
  - `positive_prompt` éé•·æ¸¬è©¦
  - ç¼ºå°‘å®‰å…¨å‰ç¶´æ¸¬è©¦

- âœ… `TestToolIntegration` - 2 å€‹æ•´åˆæ¸¬è©¦
  - å¯¦éš›å·¥å…·èª¿ç”¨æ¸¬è©¦

**ç¸½è¨ˆ**: 17 å€‹æ¸¬è©¦æ¡ˆä¾‹

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### é©—è­‰å™¨æ¶æ§‹

```python
# çµ±ä¸€é©—è­‰å…¥å£
validate_tool_output(tool_name: str, output: Dict[str, Any])
  -> (is_valid: bool, error_message: Optional[str], normalized_output: Optional[Dict])
```

### å·¥å…·æ•´åˆæ–¹å¼

```python
# åœ¨æ¯å€‹å·¥å…·å‡½æ•¸ä¸­
result = {...}  # æ§‹å»ºçµæœ

if CONTRACT_VALIDATION_ENABLED:
    is_valid, error_msg, normalized = validate_tool_output(tool_name, result)
    if not is_valid:
        logger.error(f"âŒ Contract validation failed: {error_msg}")
    else:
        result = normalized

return result
```

### Pydantic å¥‘ç´„å®šç¾©

ä½¿ç”¨ Pydantic BaseModel å®šç¾©åš´æ ¼å¥‘ç´„ï¼š
- `model_config = {"extra": "forbid"}` - ç¦æ­¢é¡å¤–éµ
- `Field(..., ge=0, le=100)` - æ•¸å€¼ç¯„åœé©—è­‰
- `@field_validator` - è‡ªå®šç¾©é©—è­‰é‚è¼¯

---

## ğŸ“Š é©—æ”¶æ¨™æº–

æ ¹æ“š `INSPIRE_P0_CHECKLIST.md`:

âœ… **æ‰€æœ‰åˆç´„æ¸¬è©¦é€šé** (`tests/test_inspire_contracts.py`)  
âœ… **æœªçŸ¥éµè¢«å¿½ç•¥æˆ–è¿”å›éŒ¯èª¤** - ä½¿ç”¨ `extra="forbid"`  
âœ… **ç¼ºå¤±å¿…è¦éµè¿”å›éŒ¯èª¤** - Pydantic è‡ªå‹•é©—è­‰

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸ·è¡Œæ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰å¥‘ç´„æ¸¬è©¦
pytest tests/test_inspire_contracts.py -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦
pytest tests/test_inspire_contracts.py::TestUnderstandIntent -v
```

### å•Ÿç”¨/åœç”¨é©—è­‰

é©—è­‰é»˜èªå•Ÿç”¨ï¼Œå¦‚æœé©—è­‰å™¨å°å…¥å¤±æ•—æœƒè‡ªå‹•åœç”¨ï¼ˆè¨˜éŒ„è­¦å‘Šï¼‰ã€‚

å¦‚æœéœ€è¦å¼·åˆ¶åœç”¨ï¼š

```python
# åœ¨ inspire_tools.py ä¸­
CONTRACT_VALIDATION_ENABLED = False
```

---

## ğŸ“ æ³¨æ„äº‹é …

1. **é©—è­‰å¤±æ•—ä¸é˜»æ­¢åŸ·è¡Œ**: é©—è­‰å¤±æ•—æ™‚æœƒè¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒè¿”å›çµæœï¼Œç¢ºä¿å‘å¾Œå…¼å®¹

2. **æ€§èƒ½å½±éŸ¿**: é©—è­‰ä½¿ç”¨ Pydanticï¼Œå°æ€§èƒ½å½±éŸ¿å¾ˆå°ï¼ˆ<1ms per callï¼‰

3. **å‘å¾Œå…¼å®¹**: å¦‚æœé©—è­‰å™¨ä¸å¯ç”¨ï¼Œå·¥å…·ä»èƒ½æ­£å¸¸å·¥ä½œ

4. **æ¸¬è©¦è¦†è“‹**: æ¸¬è©¦è¦†è“‹æ‰€æœ‰é‚Šç•Œæƒ…æ³å’ŒéŒ¯èª¤æƒ…æ³

---

## ğŸ”„ å¾ŒçºŒæ”¹é€²å»ºè­°

### P1 (çŸ­æœŸ)
- [ ] æ·»åŠ æ€§èƒ½ç›£æ§ï¼ˆé©—è­‰è€—æ™‚ï¼‰
- [ ] æ·»åŠ é©—è­‰çµ±è¨ˆï¼ˆæˆåŠŸç‡ã€å¤±æ•—åŸå› ï¼‰
- [ ] å®Œå–„éŒ¯èª¤æ¶ˆæ¯ï¼ˆæ›´å…·é«”çš„éŒ¯èª¤æç¤ºï¼‰

### P2 (ä¸­æœŸ)
- [ ] æ·»åŠ è¼¸å…¥åƒæ•¸é©—è­‰
- [ ] æ·»åŠ å·¥å…·èª¿ç”¨é »ç‡é™åˆ¶é©—è­‰
- [ ] æ•´åˆåˆ° API å±¤ï¼ˆè¿”å› 422 éŒ¯èª¤ï¼‰

### P3 (é•·æœŸ)
- [ ] æ·»åŠ å¥‘ç´„ç‰ˆæœ¬ç®¡ç†
- [ ] è‡ªå‹•ç”Ÿæˆå¥‘ç´„æ–‡æª”
- [ ] å¥‘ç´„æ¼”åŒ–è¿½è¹¤

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- **å¯¦æ–½ä¾æ“š**: `docs/INSPIRE_P0_CHECKLIST.md` Section 4
- **é©—è­‰å™¨æ¨¡çµ„**: `src/api/utils/tool_contract_validator.py`
- **æ¸¬è©¦æ–‡ä»¶**: `tests/test_inspire_contracts.py`
- **å·¥å…·å®šç¾©**: `src/api/tools/inspire_tools.py`

---

**å¯¦æ–½ç‹€æ…‹**: âœ… å·²å®Œæˆ  
**æ¸¬è©¦ç‹€æ…‹**: âœ… æ¸¬è©¦å·²å‰µå»º  
**æ–‡æª”ç‹€æ…‹**: âœ… å·²æ›´æ–°

