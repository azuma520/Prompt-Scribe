# 🧪 Supabase 資料庫測試場景設計

## 📋 測試概覽

本測試套件設計用於全面驗證 Prompt-Scribe 專案中 Supabase 資料庫的功能、效能和資料完整性。

## 🎯 測試目標

1. **資料完整性驗證**: 確保所有 140,782 筆記錄正確遷移
2. **查詢效能測試**: 驗證各種查詢場景的效能表現
3. **搜尋功能測試**: 測試文字搜尋和未來的語意搜尋
4. **API 端點測試**: 驗證 Supabase API 的各種操作
5. **併發處理測試**: 測試多用戶同時存取的情況
6. **邊界條件測試**: 測試極端情況和錯誤處理

## 🧪 測試場景分類

### 1. 基礎功能測試 (Basic Functionality Tests)

#### 1.1 連接測試
- **目的**: 驗證資料庫連接是否正常
- **測試項目**:
  - Supabase 連接狀態
  - API 金鑰驗證
  - 網路延遲測量

#### 1.2 資料存在性測試
- **目的**: 確認所有資料正確遷移
- **測試項目**:
  - 記錄總數驗證 (應為 140,782)
  - 隨機樣本檢查
  - 資料類型驗證

#### 1.3 基本 CRUD 操作測試
- **目的**: 驗證基本資料庫操作
- **測試項目**:
  - CREATE: 新增測試記錄
  - READ: 查詢特定記錄
  - UPDATE: 更新記錄內容
  - DELETE: 刪除測試記錄

### 2. 查詢效能測試 (Query Performance Tests)

#### 2.1 單表查詢測試
- **場景 1**: 按 ID 查詢 (主鍵查詢)
  ```sql
  SELECT * FROM tags_final WHERE id = ?
  ```
- **場景 2**: 按標籤名稱查詢
  ```sql
  SELECT * FROM tags_final WHERE name = ?
  ```
- **場景 3**: 按分類查詢
  ```sql
  SELECT * FROM tags_final WHERE main_category = ?
  ```

#### 2.2 範圍查詢測試
- **場景 1**: 按貼文數量範圍查詢
  ```sql
  SELECT * FROM tags_final WHERE post_count BETWEEN ? AND ?
  ```
- **場景 2**: 按信心度範圍查詢
  ```sql
  SELECT * FROM tags_final WHERE confidence >= ?
  ```

#### 2.3 複雜查詢測試
- **場景 1**: 多條件組合查詢
  ```sql
  SELECT * FROM tags_final 
  WHERE main_category = ? AND post_count > ? AND confidence > ?
  ```
- **場景 2**: 聚合查詢
  ```sql
  SELECT main_category, COUNT(*), AVG(post_count) 
  FROM tags_final GROUP BY main_category
  ```

### 3. 搜尋功能測試 (Search Functionality Tests)

#### 3.1 文字搜尋測試
- **模糊搜尋**: 使用 LIKE 或 ILIKE
- **全文搜尋**: 使用 PostgreSQL 的 FTS
- **前綴搜尋**: 標籤名稱前綴匹配

#### 3.2 分類搜尋測試
- **主分類搜尋**: 按 main_category 搜尋
- **子分類搜尋**: 按 sub_category 搜尋
- **跨分類搜尋**: 多分類組合搜尋

#### 3.3 排序和分頁測試
- **按貼文數量排序**: ORDER BY post_count DESC
- **按信心度排序**: ORDER BY confidence DESC
- **分頁查詢**: LIMIT 和 OFFSET

### 4. 資料完整性測試 (Data Integrity Tests)

#### 4.1 資料一致性測試
- **唯一性檢查**: 標籤名稱唯一性
- **參照完整性**: 外鍵約束檢查
- **資料類型檢查**: 各欄位資料類型驗證

#### 4.2 資料品質測試
- **空值檢查**: 必填欄位不為空
- **數值範圍檢查**: post_count >= 0, confidence 在 0-1 之間
- **字串格式檢查**: 標籤名稱格式驗證

### 5. 併發處理測試 (Concurrency Tests)

#### 5.1 讀取併發測試
- **同時查詢**: 多個用戶同時查詢相同資料
- **大量讀取**: 模擬高流量讀取情況

#### 5.2 寫入併發測試
- **同時寫入**: 多個用戶同時寫入不同資料
- **衝突處理**: 同時修改相同記錄的處理

### 6. 邊界條件測試 (Edge Case Tests)

#### 6.1 極限值測試
- **最大記錄查詢**: 查詢貼文數量最高的標籤
- **最小記錄查詢**: 查詢貼文數量最低的標籤
- **空字串搜尋**: 處理空搜尋條件

#### 6.2 錯誤處理測試
- **無效查詢**: 測試錯誤的 SQL 語法
- **不存在記錄**: 查詢不存在的資料
- **網路中斷**: 模擬網路連接問題

### 7. 效能基準測試 (Performance Benchmark Tests)

#### 7.1 響應時間測試
- **單次查詢**: < 100ms
- **批量查詢**: < 500ms
- **複雜查詢**: < 1000ms

#### 7.2 吞吐量測試
- **每秒查詢數**: QPS 測試
- **併發用戶數**: 最大併發支援

## 📊 測試數據集

### 測試標籤樣本
```
高頻標籤: post_count > 10000
中頻標籤: 1000 <= post_count <= 10000  
低頻標籤: post_count < 1000
```

### 測試分類樣本
```
主要分類: character, action_pose, theme_concept, adult_content
特殊字符: 包含空格、符號的標籤
多語言: 英文、日文標籤
```

## 🎯 成功標準

### 功能性標準
- ✅ 所有基本 CRUD 操作成功
- ✅ 查詢結果準確性 100%
- ✅ 資料完整性驗證通過

### 效能標準
- ✅ 單次查詢響應時間 < 100ms
- ✅ 複雜查詢響應時間 < 1000ms
- ✅ 支援 100+ 併發用戶

### 可靠性標準
- ✅ 錯誤處理機制正常
- ✅ 邊界條件處理正確
- ✅ 資料一致性維持

## 🛠️ 測試工具和框架

### Python 測試框架
- **pytest**: 主要測試框架
- **asyncio**: 異步測試支援
- **faker**: 測試資料生成

### 效能測試工具
- **locust**: 負載測試
- **asyncpg**: 高效能 PostgreSQL 連接
- **time/timeit**: 響應時間測量

### 監控工具
- **Supabase Dashboard**: 即時監控
- **PostgreSQL 統計**: 查詢效能分析
- **自定義日誌**: 詳細測試記錄

## 📋 測試執行計畫

### Phase 1: 基礎測試 (30分鐘)
1. 連接測試
2. 資料存在性驗證
3. 基本 CRUD 操作

### Phase 2: 功能測試 (60分鐘)
1. 查詢效能測試
2. 搜尋功能測試
3. 資料完整性測試

### Phase 3: 壓力測試 (45分鐘)
1. 併發處理測試
2. 效能基準測試
3. 邊界條件測試

### Phase 4: 報告生成 (15分鐘)
1. 測試結果彙總
2. 效能報告生成
3. 改進建議提出

## 📈 預期結果

### 成功指標
- **資料完整性**: 100% 通過
- **查詢準確性**: 100% 正確
- **效能達標**: 響應時間符合標準
- **併發支援**: 穩定支援多用戶

### 風險評估
- **網路延遲**: 可能影響響應時間
- **資源限制**: Supabase 免費方案限制
- **查詢複雜度**: 複雜查詢可能較慢

這個測試場景設計涵蓋了資料庫的各個方面，確保我們的 Supabase 部署能夠滿足實際使用需求。
