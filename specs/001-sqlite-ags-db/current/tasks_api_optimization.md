# 📋 API 優化任務清單

**專案**: PLAN-2025-005 - API 優化與 LLM 友好設計  
**建立日期**: 2025-01-14  
**狀態**: Planning → In Progress

---

## 🎯 Phase 1: 基礎 API 開發（Week 1）

### 階段目標
- 建立 FastAPI 專案結構
- 實作基礎標籤查詢端點
- 整合 Supabase 連接
- 完成基本測試

---

### T101 ⬜ [Setup] 建立 API 專案結構
**優先級**: 🔥 高  
**預估時間**: 1 小時  
**依賴**: 無

**任務內容**:
```bash
mkdir -p prompt-scribe-api/api/{routers/{v1,llm,admin},services,models,tests,data}
建立核心檔案: main.py, config.py, requirements.txt
設置 .env 環境配置
```

**驗收標準**:
- [ ] 目錄結構正確建立
- [ ] requirements.txt 包含所有必要依賴
- [ ] .env 配置完整

---

### T102 ⬜ [Setup] 配置 Supabase 連接
**優先級**: 🔥 高  
**預估時間**: 30 分鐘  
**依賴**: T101

**任務內容**:
- 建立 `services/supabase_client.py`
- 實作連接池和快取機制
- 測試連接和查詢功能

**驗收標準**:
- [ ] Supabase 連接成功
- [ ] 可以查詢 tags_final 表
- [ ] 錯誤處理完善

---

### T103 ⬜ [Dev] 實作基礎標籤查詢端點
**優先級**: 🔥 高  
**預估時間**: 2 小時  
**依賴**: T102

**任務內容**:
- `GET /api/v1/tags` - 標籤列表查詢
- `GET /api/v1/tags/{name}` - 單一標籤詳情
- `GET /api/v1/categories` - 分類列表
- 實作分頁、篩選、排序功能

**驗收標準**:
- [ ] 所有端點可正常訪問
- [ ] 分頁功能正確
- [ ] 篩選和排序功能正確
- [ ] 響應時間 < 500ms

---

### T104 ⬜ [Dev] 實作文字搜尋端點
**優先級**: 🔥 高  
**預估時間**: 1.5 小時  
**依賴**: T102

**任務內容**:
- `POST /api/v1/search` - 基本文字搜尋
- 支援模糊匹配（ILIKE）
- 支援多條件組合
- 流行度排序

**驗收標準**:
- [ ] 文字搜尋功能正確
- [ ] 支援分類篩選
- [ ] 結果按流行度排序
- [ ] 響應時間 < 400ms

---

### T105 ⬜ [Dev] 實作統計端點
**優先級**: 🟡 中  
**預估時間**: 1 小時  
**依賴**: T102

**任務內容**:
- `GET /api/v1/stats` - 基本統計資訊
- 總標籤數、分類統計、覆蓋率等

**驗收標準**:
- [ ] 統計資料準確
- [ ] 響應速度快（< 200ms）
- [ ] 包含有用的元資訊

---

### T106 ⬜ [Test] 基礎 API 測試
**優先級**: 🔥 高  
**預估時間**: 2 小時  
**依賴**: T103, T104, T105

**任務內容**:
- 編寫端點單元測試
- 整合測試
- 效能測試
- 錯誤處理測試

**驗收標準**:
- [ ] 所有測試通過
- [ ] 測試覆蓋率 > 80%
- [ ] 效能符合目標

---

## 🤖 Phase 2: LLM 專用端點（Week 2）

### 階段目標
- 建立關鍵字擴展系統
- 實作智能標籤推薦
- 實作品質驗證功能
- 完成 LLM 整合文檔

---

### T201 ⬜ [Dev] 建立關鍵字擴展系統
**優先級**: 🔥 高  
**預估時間**: 3 小時  
**依賴**: T101

**任務內容**:
- 建立 `data/keyword_synonyms.yaml` 同義詞字典
- 實作 `services/keyword_expander.py`
- 實作關鍵字提取和擴展邏輯
- 建立測試案例

**驗收標準**:
- [ ] 同義詞字典包含 > 100 個條目
- [ ] 擴展算法正確
- [ ] 擴展後關鍵字數量增加 2-3 倍
- [ ] 測試通過率 100%

**同義詞字典範例**:
```yaml
character:
  girl: [1girl, female, woman]
  boy: [1boy, male, man]
  alone: [solo, single, solitary]

emotion:
  lonely: [solo, alone, isolated]
  happy: [smile, smiling, cheerful]

style:
  cyberpunk: [neon, futuristic, sci-fi, cyber]
  anime: [manga, japanese_style, illustration]
```

---

### T202 ⬜ [Dev] 實作智能標籤推薦端點
**優先級**: 🔥 高  
**預估時間**: 4 小時  
**依賴**: T201

**任務內容**:
- `POST /api/llm/recommend-tags` 端點實作
- 整合關鍵字擴展
- 實作智能排序算法
- 生成詳細解釋和建議

**驗收標準**:
- [ ] 端點功能完整
- [ ] 推薦結果相關性 > 85%
- [ ] 響應時間 < 300ms
- [ ] 包含豐富的解釋資訊

---

### T203 ⬜ [Dev] 實作標籤品質驗證端點
**優先級**: 🔥 高  
**預估時間**: 3 小時  
**依賴**: T102

**任務內容**:
- `POST /api/llm/validate-prompt` 端點實作
- 建立衝突檢測規則
- 實作品質評分算法
- 生成改進建議

**驗收標準**:
- [ ] 能檢測常見衝突（如 solo + 2girls）
- [ ] 品質評分合理
- [ ] 改進建議有幫助
- [ ] 響應時間 < 200ms

---

### T204 ⬜ [Dev] 實作分類熱門標籤端點
**優先級**: 🟡 中  
**預估時間**: 1.5 小時  
**依賴**: T102

**任務內容**:
- `GET /api/llm/popular-by-category` 端點實作
- 支援分類篩選
- 包含使用建議

**驗收標準**:
- [ ] 返回最熱門的標籤
- [ ] 分類篩選正確
- [ ] 包含有用的使用提示

---

### T205 ⬜ [Dev] 實作智能關鍵字搜尋端點
**優先級**: 🟡 中  
**預估時間**: 2 小時  
**依賴**: T201

**任務內容**:
- `POST /api/llm/search-by-keywords` 端點實作
- 整合關鍵字擴展
- 實作智能排序

**驗收標準**:
- [ ] 搜尋結果相關性高
- [ ] 顯示匹配類型和關鍵字
- [ ] 響應時間 < 250ms

---

### T206 ⬜ [Dev] 實作快取機制
**優先級**: 🟡 中  
**預估時間**: 2 小時  
**依賴**: T202, T203

**任務內容**:
- 實作記憶體快取
- 快取常見查詢結果
- 設置 TTL 和快取淘汰策略

**驗收標準**:
- [ ] 快取命中率 > 40%
- [ ] 快取命中時響應 < 50ms
- [ ] 快取一致性正確

---

### T207 ⬜ [Test] LLM 端點完整測試
**優先級**: 🔥 高  
**預估時間**: 3 小時  
**依賴**: T202, T203, T204, T205

**任務內容**:
- 單元測試（每個端點）
- 整合測試（LLM 完整工作流程）
- 效能測試
- 邊界條件測試

**驗收標準**:
- [ ] 所有測試通過
- [ ] 測試覆蓋率 > 85%
- [ ] 效能符合目標
- [ ] 錯誤處理完善

---

## 📚 Phase 3: 文檔和範例（Week 3）

### T301 ⬜ [Docs] 編寫 LLM 整合指南
**優先級**: 🔥 高  
**預估時間**: 3 小時  
**依賴**: T207

**任務內容**:
- 編寫詳細的 LLM 整合文檔
- 建立 GPT-4 Function Calling 定義
- 建立 Claude Tools 定義
- 提供完整的使用範例

**驗收標準**:
- [ ] 文檔清晰易懂
- [ ] 包含主流 LLM 的工具定義
- [ ] 範例程式碼可直接執行

---

### T302 ⬜ [Docs] 更新 OpenAPI 規格
**優先級**: 🟡 中  
**預估時間**: 2 小時  
**依賴**: T207

**任務內容**:
- 更新 `api_endpoints_llm_optimized.yaml`
- 確保與實際實作一致
- 生成 Swagger 文檔

**驗收標準**:
- [ ] OpenAPI 規格完整
- [ ] Swagger UI 可正常訪問
- [ ] 所有端點都有詳細描述

---

### T303 ⬜ [Docs] 建立使用範例
**優先級**: 🟡 中  
**預估時間**: 2 小時  
**依賴**: T207

**任務內容**:
- Python SDK 範例
- cURL 範例
- JavaScript 範例
- LLM Tool 使用範例

**驗收標準**:
- [ ] 所有範例可執行
- [ ] 涵蓋常見使用場景
- [ ] 包含錯誤處理示範

---

## 🚀 Phase 4: 部署和監控（Week 4）

### T401 ⬜ [Deploy] 容器化和部署準備
**優先級**: 🔥 高  
**預估時間**: 3 小時  
**依賴**: T302

**任務內容**:
- 建立 Dockerfile
- 配置 docker-compose
- 準備生產環境變數
- 設置健康檢查

**驗收標準**:
- [ ] Docker 容器可正常運行
- [ ] 環境變數配置完整
- [ ] 健康檢查端點正常

---

### T402 ⬜ [Deploy] 部署到雲端平台
**優先級**: 🔥 高  
**預估時間**: 2 小時  
**依賴**: T401

**任務內容**:
- 選擇部署平台（Vercel/Railway/Render）
- 配置部署流程
- 設置環境變數
- 驗證部署成功

**驗收標準**:
- [ ] API 成功部署
- [ ] 所有端點可訪問
- [ ] HTTPS 配置正確

---

### T403 ⬜ [Monitor] 建立監控和日誌
**優先級**: 🟡 中  
**預估時間**: 2 小時  
**依賴**: T402

**任務內容**:
- 實作 API 使用量追蹤
- 設置錯誤日誌
- 建立效能監控
- 配置告警

**驗收標準**:
- [ ] 可追蹤 API 調用次數
- [ ] 錯誤日誌完整
- [ ] 效能指標可視化

---

## 🔮 Phase 5: 未來擴展（延後）

### T501 ⬜ [Research] 評估向量搜尋需求
**優先級**: 🟢 低  
**預估時間**: 1 天  
**依賴**: T403 + 1 個月使用數據

**任務內容**:
- 分析關鍵字搜尋的覆蓋率
- 識別無法滿足的查詢類型
- 評估向量搜尋的投資報酬率
- 決定是否需要向量化

**驗收標準**:
- [ ] 完整的使用數據分析
- [ ] 明確的決策建議
- [ ] 成本效益評估

---

### T502 ⬜ [Dev] Embedding 生成（可選）
**優先級**: 🟢 低  
**預估時間**: 1 週  
**依賴**: T501（且決定需要）

**任務內容**:
- 建立批次 embedding 生成腳本
- 調用 OpenAI API 生成向量
- 儲存到 tag_embeddings 表
- 驗證向量品質

**驗收標準**:
- [ ] 所有標籤已向量化
- [ ] 向量品質符合標準
- [ ] 成本在預算內

---

### T503 ⬜ [Dev] 語意搜尋 API（可選）
**優先級**: 🟢 低  
**預估時間**: 3 天  
**依賴**: T502

**任務內容**:
- 實作 `POST /api/llm/semantic-search-by-text`
- 建立 Edge Function 處理 embedding 生成
- 整合向量搜尋
- 實作快取機制

**驗收標準**:
- [ ] 語意搜尋功能正確
- [ ] 一次 API 調用完成所有工作
- [ ] 響應時間 < 500ms
- [ ] 結果相關性 > 90%

---

## 📊 任務統計

### 優先級分佈
- 🔥 高優先級: 9 個任務（立即執行）
- 🟡 中優先級: 6 個任務（本月完成）
- 🟢 低優先級: 3 個任務（未來考慮）

### 時間估算
- **Phase 1** (Week 1): ~8-10 小時
- **Phase 2** (Week 2): ~15-18 小時
- **Phase 3** (Week 3): ~7-9 小時
- **Phase 4** (Week 4): ~7-9 小時
- **總計**: ~37-46 小時（約 1 個月）

### 關鍵里程碑
- ✅ **Day 3**: 基礎 API 可用
- ✅ **Day 7**: 基礎功能完整
- ✅ **Day 14**: LLM 端點完成
- ✅ **Day 21**: 文檔和測試完成
- ✅ **Day 28**: 部署上線

---

## 🎯 本週優先任務（立即開始）

1. **今天**:
   - [ ] T101: 建立專案結構
   - [ ] T102: 配置 Supabase 連接
   - [ ] T103: 實作第一個端點

2. **明天**:
   - [ ] T104: 實作搜尋端點
   - [ ] T105: 實作統計端點
   - [ ] T201: 建立關鍵字擴展系統

3. **本週末**:
   - [ ] T106: 完成基礎測試
   - [ ] T202: 開始 LLM 推薦端點

---

## 📝 注意事項

### 開發原則
- ✅ 先實作核心功能，再添加輔助功能
- ✅ 每個端點都要有測試
- ✅ 保持程式碼簡單和可讀
- ✅ 文檔與程式碼同步更新

### 品質標準
- ✅ API 響應時間 < 500ms (P95)
- ✅ 測試覆蓋率 > 80%
- ✅ 錯誤率 < 1%
- ✅ 文檔完整度 100%

### 技術債務管理
- ✅ 避免過度設計
- ✅ 先實作簡單版本
- ✅ 收集回饋後優化
- ✅ 保持重構空間

---

## 🎊 完成標準

**Phase 1-2 完成標準**:
- [ ] 所有 T101-T207 任務完成
- [ ] 基礎 API 和 LLM 端點全部可用
- [ ] 所有測試通過
- [ ] API 效能符合目標
- [ ] 文檔完整

**整體專案完成標準**:
- [ ] API 成功部署到生產環境
- [ ] LLM 可以成功整合
- [ ] 用戶回饋正面
- [ ] 系統穩定運行（Uptime > 99%）

---

## 📌 下一步

**立即行動**: 開始 T101 - 建立 API 專案結構

**準備材料**: 
- Supabase 連接資訊（已有）
- 開發環境（Python 3.9+）
- 時間投入（每天 2-3 小時）

**切換到 Agent 模式開始實作！** 🚀
