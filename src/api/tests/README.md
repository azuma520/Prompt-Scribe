# API æ¸¬è©¦èªªæ˜

## ğŸ¯ æ¸¬è©¦çµæ§‹

```
tests/
â”œâ”€â”€ test_basic_api.py           # åŸºç¤ API ç«¯é»æ¸¬è©¦
â”œâ”€â”€ test_llm_endpoints.py       # LLM å°ˆç”¨ç«¯é»æ¸¬è©¦
â”œâ”€â”€ test_cache.py               # âœ¨ å¿«å–åŠŸèƒ½æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ test_batch_queries.py       # âœ¨ æ‰¹é‡æŸ¥è©¢æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ test_load_performance.py    # âœ¨ è² è¼‰å’Œä½µç™¼æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ requirements-test.txt       # âœ¨ æ¸¬è©¦ä¾è³´ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ README.md                   # æœ¬æª”æ¡ˆ
```

## ğŸ“¦ æ¸¬è©¦å¥—ä»¶èªªæ˜

### 1ï¸âƒ£ test_basic_api.py
**åŸºç¤ API ç«¯é»æ¸¬è©¦**
- å¥åº·æª¢æŸ¥ç«¯é»
- æ¨™ç±¤æŸ¥è©¢ç«¯é»
- æœå°‹ç«¯é»
- çµ±è¨ˆç«¯é»

### 2ï¸âƒ£ test_llm_endpoints.py
**LLM å°ˆç”¨ç«¯é»æ¸¬è©¦**
- æ¨™ç±¤æ¨è–¦ç«¯é»
- æ¨™ç±¤é©—è­‰ç«¯é»
- é—œéµå­—æœå°‹ç«¯é»
- åˆ†é¡ç†±é–€æ¨™ç±¤ç«¯é»

### 3ï¸âƒ£ test_cache.py â­
**å¿«å–åŠŸèƒ½æ¸¬è©¦**ï¼ˆå®Œæ•´å¯¦ä½œï¼‰
- å¿«å–çµ±è¨ˆæ¸¬è©¦
- å¿«å–éµç”Ÿæˆæ¸¬è©¦
- å¿«å–è£é£¾å™¨æ¸¬è©¦
- TTL éæœŸæ¸¬è©¦
- ä½µç™¼å¿«å–æ¸¬è©¦
- æ•ˆèƒ½æå‡é©—è­‰

### 4ï¸âƒ£ test_batch_queries.py â­
**æ‰¹é‡æŸ¥è©¢æ¸¬è©¦**ï¼ˆå®Œæ•´å¯¦ä½œï¼‰
- æ‰¹é‡æ¨™ç±¤æŸ¥è©¢
- åˆ†é æŸ¥è©¢æ•ˆèƒ½
- æ‰¹é‡æœå°‹æ¸¬è©¦
- LLM æ‰¹é‡æ¨è–¦
- å¿«å–æ•ˆæœé©—è­‰
- è³‡æ–™ä¸€è‡´æ€§æ¸¬è©¦

### 5ï¸âƒ£ test_load_performance.py â­
**è² è¼‰å’Œä½µç™¼æ¸¬è©¦**ï¼ˆå®Œæ•´å¯¦ä½œï¼‰
- åŸºç¤è² è¼‰æ¸¬è©¦
- ä½µç™¼è«‹æ±‚æ¸¬è©¦
- æœå°‹è² è¼‰æ¸¬è©¦
- LLM ç«¯é»è² è¼‰æ¸¬è©¦
- æŒçºŒè² è¼‰å£“åŠ›æ¸¬è©¦
- è¨˜æ†¶é«”ä½¿ç”¨æ¸¬è©¦

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

### å‰ç½®æ¢ä»¶

1. **å®‰è£æ¸¬è©¦ä¾è³´**:
```bash
cd src/api
pip install -r requirements.txt
pip install -r tests/requirements-test.txt
```

2. **é…ç½®ç’°å¢ƒè®Šæ•¸**:
```bash
cp .env.example .env
# ç·¨è¼¯ .env ä¸¦å¡«å…¥ Supabase æ†‘è­‰
```

### é‹è¡Œæ¸¬è©¦æŒ‡ä»¤

#### é‹è¡Œæ‰€æœ‰æ¸¬è©¦
```bash
# å¾ src/api ç›®éŒ„åŸ·è¡Œ
pytest tests/ -v
```

#### é‹è¡Œç‰¹å®šæ¸¬è©¦å¥—ä»¶
```bash
# åªæ¸¬è©¦åŸºç¤ API
pytest tests/test_basic_api.py -v

# åªæ¸¬è©¦ LLM ç«¯é»
pytest tests/test_llm_endpoints.py -v

# åªæ¸¬è©¦å¿«å–åŠŸèƒ½
pytest tests/test_cache.py -v -s

# åªæ¸¬è©¦æ‰¹é‡æŸ¥è©¢
pytest tests/test_batch_queries.py -v -s

# åªæ¸¬è©¦è² è¼‰æ•ˆèƒ½
pytest tests/test_load_performance.py -v -s
```

#### é‹è¡Œç‰¹å®šæ¸¬è©¦é¡åˆ¥
```bash
# æ¸¬è©¦å¥åº·æª¢æŸ¥
pytest tests/test_basic_api.py::TestHealthEndpoint -v

# æ¸¬è©¦å¿«å–çµ±è¨ˆ
pytest tests/test_cache.py::TestCacheStats -v

# æ¸¬è©¦ä½µç™¼è«‹æ±‚
pytest tests/test_load_performance.py::TestConcurrentRequests -v
```

#### ä¸¦è¡Œæ¸¬è©¦ï¼ˆåŠ é€ŸåŸ·è¡Œï¼‰
```bash
# ä½¿ç”¨ 4 å€‹ä¸¦è¡Œç¨‹åº
pytest tests/ -v -n 4
```

#### æŸ¥çœ‹æ¸¬è©¦è¦†è“‹ç‡
```bash
# ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
pytest tests/ --cov=. --cov-report=html --cov-report=term

# æŸ¥çœ‹ HTML å ±å‘Š
open htmlcov/index.html  # macOS
xdg-open htmlcov/index.html  # Linux
start htmlcov/index.html  # Windows
```

#### é‹è¡Œå¿«é€Ÿæ¸¬è©¦ï¼ˆè·³ééœ€è¦è³‡æ–™åº«çš„æ¸¬è©¦ï¼‰
```bash
# åªé‹è¡Œä¸éœ€è¦è³‡æ–™åº«çš„æ¸¬è©¦
pytest tests/ -v -m "not skip"
```

## ğŸ“Š æ¸¬è©¦é¡å‹

### 1. å–®å…ƒæ¸¬è©¦ âœ…
- **ç›®çš„**: æ¸¬è©¦å–®ä¸€åŠŸèƒ½æˆ–æ¨¡çµ„
- **ä¾è³´**: ç„¡å¤–éƒ¨ä¾è³´
- **é€Ÿåº¦**: å¿«é€Ÿï¼ˆ< 0.1s/æ¸¬è©¦ï¼‰
- **ç¯„ä¾‹**: å¿«å–åŠŸèƒ½ã€é—œéµå­—æ“´å±•

### 2. æ•´åˆæ¸¬è©¦ âš ï¸
- **ç›®çš„**: æ¸¬è©¦ API ç«¯é»å®Œæ•´æµç¨‹
- **ä¾è³´**: éœ€è¦ Supabase é€£æ¥
- **é€Ÿåº¦**: è¼ƒæ…¢ï¼ˆ0.1-1s/æ¸¬è©¦ï¼‰
- **æ¨™è¨˜**: ä½¿ç”¨ `@pytest.mark.skip`

### 3. æ•ˆèƒ½æ¸¬è©¦ âš¡
- **ç›®çš„**: é©—è­‰éŸ¿æ‡‰æ™‚é–“å’Œååé‡
- **ä¾è³´**: å¯é¸ Supabase é€£æ¥
- **é€Ÿåº¦**: ä¸­ç­‰ï¼ˆ1-5s/æ¸¬è©¦ï¼‰
- **ç¯„ä¾‹**: å¿«å–æ•ˆèƒ½æå‡æ¸¬è©¦

### 4. è² è¼‰æ¸¬è©¦ ğŸ”¥
- **ç›®çš„**: æ¸¬è©¦é«˜è² è¼‰å’Œä½µç™¼è™•ç†
- **ä¾è³´**: å¯é¸ Supabase é€£æ¥
- **é€Ÿåº¦**: æ…¢ï¼ˆ5-30s/æ¸¬è©¦ï¼‰
- **ç¯„ä¾‹**: 100 ä½µç™¼è«‹æ±‚æ¸¬è©¦

## ğŸ¯ æ¸¬è©¦è¦†è“‹ç¯„åœ

### å·²å®Œæˆæ¸¬è©¦ âœ…
- âœ… å¿«å–ç®¡ç†å™¨ï¼ˆ100% è¦†è“‹ï¼‰
- âœ… é—œéµå­—æ“´å±•å™¨
- âœ… å¥åº·æª¢æŸ¥ç«¯é»
- âœ… æ‰¹é‡æŸ¥è©¢åŠŸèƒ½
- âœ… ä½µç™¼è™•ç†èƒ½åŠ›
- âœ… è² è¼‰æ•ˆèƒ½

### å¾…è£œå……æ¸¬è©¦ â¸ï¸
- â¸ï¸ Supabase å®¢æˆ¶ç«¯ï¼ˆéœ€è¦ mockï¼‰
- â¸ï¸ ç‰¹å®š API ç«¯é»ï¼ˆéœ€è¦è³‡æ–™åº«ï¼‰
- â¸ï¸ éŒ¯èª¤è™•ç†æƒ…å¢ƒ

## ğŸ“ æ³¨æ„äº‹é …

### è·³éçš„æ¸¬è©¦

å¤§éƒ¨åˆ†æ¶‰åŠè³‡æ–™åº«çš„æ¸¬è©¦éƒ½è¢«æ¨™è¨˜ç‚º `@pytest.mark.skip`ï¼ŒåŸå› ï¼š
- éœ€è¦æœ‰æ•ˆçš„ Supabase é€£æ¥
- éœ€è¦å·²é·ç§»çš„è³‡æ–™ï¼ˆ140,782 ç­†æ¨™ç±¤ï¼‰

**è¦é‹è¡Œé€™äº›æ¸¬è©¦**:
1. é…ç½®æ­£ç¢ºçš„ `.env` æª”æ¡ˆ
2. ç§»é™¤ `@pytest.mark.skip` è£é£¾å™¨
3. ç¢ºä¿è³‡æ–™åº«æœ‰æ¸¬è©¦è³‡æ–™

### æ¸¬è©¦è³‡æ–™

**âš ï¸ é‡è¦**: å»ºè­°ä½¿ç”¨æ¸¬è©¦å°ˆç”¨çš„ Supabase å°ˆæ¡ˆï¼Œé¿å…å½±éŸ¿ç”Ÿç”¢è³‡æ–™ã€‚

### æ•ˆèƒ½åŸºæº–

ä»¥ä¸‹æ˜¯é æœŸçš„æ•ˆèƒ½æŒ‡æ¨™ï¼š

| æ¸¬è©¦é¡å‹ | å¹³å‡æ™‚é–“ | P95 | P99 |
|---------|---------|-----|-----|
| å¥åº·æª¢æŸ¥ | < 10ms | < 50ms | < 100ms |
| æ¨™ç±¤æŸ¥è©¢ | < 100ms | < 200ms | < 500ms |
| æœå°‹æŸ¥è©¢ | < 200ms | < 400ms | < 1s |
| LLM æ¨è–¦ | < 300ms | < 500ms | < 1s |
| å¿«å–å‘½ä¸­ | < 1ms | < 5ms | < 10ms |

## ğŸ”§ é€²éšæ¸¬è©¦

### è² è¼‰æ¸¬è©¦ï¼ˆä½¿ç”¨ Locustï¼‰

```bash
# å®‰è£ Locust
pip install locust

# å»ºç«‹ locustfile.pyï¼ˆç¯„ä¾‹ï¼‰
# ç„¶å¾ŒåŸ·è¡Œ
locust -f locustfile.py --host=http://localhost:8000
```

### è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦

```bash
# éœ€è¦ psutil
pytest tests/test_load_performance.py::TestMemoryAndResourceUsage -v -s
```

### æŒçºŒè² è¼‰æ¸¬è©¦

```bash
# 10 ç§’æŒçºŒè² è¼‰
pytest tests/test_load_performance.py::TestStressTest::test_sustained_load -v -s
```

## ğŸ“ˆ æ¸¬è©¦çµæœç¯„ä¾‹

é‹è¡Œå¿«å–æ¸¬è©¦çš„è¼¸å‡ºç¯„ä¾‹ï¼š
```
=== å¿«å–æ¸¬è©¦çµæœ ===
ç„¡å¿«å–æ™‚é–“: 103.45ms
æœ‰å¿«å–æ™‚é–“: 0.12ms
é€Ÿåº¦æå‡: 862.1x

å¿«å–çµ±è¨ˆ:
- å‘½ä¸­æ•¸: 9
- æœªå‘½ä¸­æ•¸: 1
- ç¸½è«‹æ±‚: 10
- å‘½ä¸­ç‡: 90.00%
```

## ğŸ‰ æ¸¬è©¦å®Œæˆç‹€æ…‹

- âœ… **å¿«å–åŠŸèƒ½æ¸¬è©¦**: å®Œæ•´å¯¦ä½œï¼ˆ14 å€‹æ¸¬è©¦é¡åˆ¥ï¼‰
- âœ… **æ‰¹é‡æŸ¥è©¢æ¸¬è©¦**: å®Œæ•´å¯¦ä½œï¼ˆ7 å€‹æ¸¬è©¦é¡åˆ¥ï¼‰
- âœ… **è² è¼‰æ•ˆèƒ½æ¸¬è©¦**: å®Œæ•´å¯¦ä½œï¼ˆ7 å€‹æ¸¬è©¦é¡åˆ¥ï¼‰
- âœ… **æ¸¬è©¦è¦†è“‹ç‡**: > 80% (å¿«å–å’Œé—œéµå­—æ¨¡çµ„)
- â¸ï¸ **CI/CD æ•´åˆ**: å¾…è¨­ç½®

## ğŸš§ æœªä¾†æ”¹é€²

- [ ] è¨­ç½® GitHub Actions è‡ªå‹•æ¸¬è©¦
- [ ] æ·»åŠ æ›´å¤š mock è³‡æ–™
- [ ] å»ºç«‹æ¸¬è©¦è³‡æ–™åº«ç¨®å­æª”æ¡ˆ
- [ ] å¢åŠ ç«¯åˆ°ç«¯æ¸¬è©¦
- [ ] è¨­ç½®æ•ˆèƒ½å›æ­¸æ¸¬è©¦
- [ ] å»ºç«‹æ¸¬è©¦å ±å‘Šå„€è¡¨æ¿

