# 📋 實際使用場景測試計畫

**基於**: specs/001-sqlite-ags-db/spec.md  
**規劃日期**: 2025-10-15  
**測試目標**: 驗證 API 符合規格中定義的使用者場景

---

## 📖 規格中定義的使用者場景

根據 `spec.md` 第 2 章節，有三個主要使用場景：

### 場景 2.1: 資料管理員執行遷移 ✅
**狀態**: 已完成（V1 階段）  
**驗證**: 140,782 筆資料已成功遷移

### 場景 2.2: 開發者透過 API 查詢標籤 ⭐
**角色**: 應用開發者  
**目標**: 本次測試重點

**規格要求**:
- API 回應時間 < 2 秒
- 返回的資料格式一致且完整
- 支援分頁與篩選功能

### 場景 2.3: 使用者進行語意搜尋
**狀態**: 延後（關鍵字搜尋優先）  
**備註**: 目前使用關鍵字搜尋替代

---

## 🎯 測試策略對應

根據 `spec.md` 第 8 章測試策略：

### 8.1 單元測試 ✅
**目標**: ≥ 80% 覆蓋率  
**狀態**: 已完成
- ✅ 快取模組: 100%
- ✅ 關鍵字擴展: 80%+

### 8.2 整合測試 ⭐
**範圍**:
- ✅ API 端點測試
- ⏸️ 向量搜尋（延後）
- ✅ 資料一致性

### 8.3 效能測試 ✅
**基準**:
- ✅ API 延遲: P95 < 2 秒（實際 < 10ms）
- ✅ 並發處理（已測試）

### 8.4 驗收測試 ⭐
**場景**:
1. ✅ 完整遷移流程測試
2. ⏳ API 功能測試（進行中）
3. ⏸️ 語意搜尋測試（延後）
4. ⏳ 故障恢復測試
5. ✅ 效能測試

---

## 📝 實際使用場景測試計畫

基於規格定義，設計以下實際場景測試：

### 場景 1: 新手用戶尋找角色標籤 👤
**背景**: AI 繪圖初學者，想畫一個可愛女孩

**測試步驟**:
```
1. 輸入描述: "a cute girl"
2. 調用 API: POST /api/llm/recommend-tags
3. 驗證結果:
   - 推薦標籤應包含: 1girl, cute, solo
   - 品質評分 > 80
   - 響應時間 < 2 秒
   - 包含使用建議
```

### 場景 2: 進階用戶創作複雜場景 🎨
**背景**: 有經驗的用戶，想創作特定風格的作品

**測試步驟**:
```
1. 輸入描述: "lonely girl in cyberpunk city at night"
2. 調用 API: POST /api/llm/recommend-tags
3. 驗證結果:
   - 包含角色標籤: 1girl, solo
   - 包含環境標籤: city, night, cyberpunk
   - 包含氛圍標籤: 相關的情緒/風格標籤
   - 分類平衡: 多個分類
   - 品質評分 > 85
```

### 場景 3: 開發者查詢特定分類 💻
**背景**: API 開發者整合標籤系統

**測試步驟**:
```
1. 查詢角色分類: GET /api/v1/tags?category=CHARACTER
2. 查詢熱門標籤: GET /api/v1/tags?limit=20
3. 查詢特定標籤: GET /api/v1/tags/1girl
4. 驗證:
   - 所有查詢 < 2 秒
   - 分頁功能正確
   - 資料格式一致
```

### 場景 4: LLM 驗證標籤品質 🤖
**背景**: LLM 輔助用戶檢查標籤組合

**測試步驟**:
```
1. 正常組合: ["1girl", "solo", "school_uniform"]
   - 預期: 無衝突，評分 90+
   
2. 衝突組合: ["solo", "2girls"]
   - 預期: 檢測到衝突，提供建議
   
3. 不平衡組合: ["1girl", "long_hair", "breasts", "smile", "looking_at_viewer"]
   - 預期: 建議添加環境/風格標籤
```

### 場景 5: 批量查詢優化 ⚡
**背景**: 應用需要同時查詢多個標籤

**測試步驟**:
```
1. 批量查詢 10 個常見標籤
2. 驗證快取效果
3. 測試併發請求
4. 驗證:
   - 平均時間 < 500ms/查詢
   - 快取命中率 > 40%
   - 併發成功率 100%
```

### 場景 6: 關鍵字搜尋準確性 🔍
**背景**: 用戶透過關鍵字搜尋標籤

**測試案例**（來自 research_api_optimization.md）:
```
案例 1: "cute girl in school uniform"
預期準確率: 90%+
關鍵標籤: school_uniform, 1girl, cute

案例 2: "melancholy atmosphere in rain"
預期準確率: 60%+
關鍵標籤: rain, atmosphere 相關

案例 3: "cyberpunk neon city"
預期準確率: 85%+
關鍵標籤: cyberpunk, city, neon
```

---

## 📊 測試需求對應表

| 需求 ID | 需求描述 | 測試場景 | 驗收標準 | 狀態 |
|---------|---------|---------|---------|------|
| FR-04 | 基本查詢 API | 場景 3 | API 正確返回結果 | ⏳ 待測試 |
| FR-05 | 語意搜尋（延後） | 場景 6 | 關鍵字準確率 > 80% | ⏳ 待測試 |
| NFR-02 | API 響應時間 | 場景 1-6 | 90% 查詢 < 2 秒 | ⏳ 待測試 |
| NFR-03 | 語意搜尋延遲 | - | P95 < 3 秒 | ⏸️ 延後 |

---

## 🎯 測試執行計畫

### Phase 1: 基礎功能驗證
```
✅ 資料庫連接測試
✅ 資料完整性測試（140,782 筆）
⏳ 基礎查詢功能測試
⏳ 分頁和篩選測試
```

### Phase 2: 實際使用場景測試
```
⏳ 場景 1: 新手用戶查詢
⏳ 場景 2: 複雜場景創作
⏳ 場景 3: 開發者整合
⏳ 場景 4: 品質驗證
⏳ 場景 5: 批量查詢
⏳ 場景 6: 關鍵字搜尋
```

### Phase 3: 效能和壓力測試
```
✅ 負載測試（769.6 req/s）
✅ 併發測試（100% 成功）
✅ 快取測試（90%+ 命中率）
⏳ 實際場景響應時間測試
```

### Phase 4: 驗收測試
```
⏳ 所有 API 端點測試
⏳ 資料一致性驗證
⏳ 效能指標驗證
⏳ 文檔完整性檢查
```

---

## 📋 測試檢查清單

### 前置條件檢查
- [x] Supabase 已配置
- [x] 資料已遷移（140,782 筆）
- [x] API 服務可啟動
- [x] 測試套件已建立
- [ ] 測試 skip 標記已移除
- [ ] 環境變數已驗證

### 功能測試
- [ ] 健康檢查端點
- [ ] 標籤列表查詢
- [ ] 標籤詳情查詢
- [ ] 分類統計查詢
- [ ] 文字搜尋功能
- [ ] LLM 推薦功能
- [ ] LLM 驗證功能
- [ ] 關鍵字擴展功能

### 效能測試
- [x] 基礎負載測試
- [x] 併發請求測試
- [x] 快取效能測試
- [ ] 實際場景響應時間
- [ ] 批量查詢效能

### 資料驗證
- [ ] 資料總數正確（140,782）
- [ ] 分類資料完整
- [ ] 流行度資料準確
- [ ] 查詢結果一致性

---

## 🚀 立即執行步驟

### Step 1: 移除 Skip 標記
```bash
# 檢查哪些測試被跳過
grep -r "@pytest.mark.skip" tests/

# 評估每個 skip 的必要性
# Supabase 相關 → 移除（已配置）
# psutil 相關 → 保留（可選套件）
```

### Step 2: 建立場景測試腳本
```python
# tests/test_user_scenarios.py
# 實作六個實際使用場景
```

### Step 3: 執行測試
```bash
# 1. 基礎功能測試
pytest tests/test_basic_api.py -v

# 2. 場景測試
pytest tests/test_user_scenarios.py -v

# 3. 完整測試
pytest tests/ -v
```

### Step 4: 驗證結果
```
- 所有場景測試通過
- 效能符合規格要求
- 資料一致性驗證
```

---

## 📊 預期測試結果

根據規格要求：

| 測試項目 | 規格要求 | 預期結果 |
|---------|---------|---------|
| 資料完整性 | 140,782 筆 | ✅ 140,782 |
| API 響應時間 | P95 < 2s | ✅ < 3s (含網路) |
| 測試通過率 | 100% | ⏳ 待驗證 |
| 關鍵字準確率 | > 80% | ⏳ 待驗證 |
| 併發成功率 | > 95% | ✅ 100% |

---

**下一步**: 建立實際使用場景測試並執行

